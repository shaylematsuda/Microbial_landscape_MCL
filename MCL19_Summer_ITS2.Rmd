---
title: "MCL19 ITS2"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
This is from the Microbial Landscape experiment (summer). ITS2 data from Symportal. 
```{r}
rm(list=ls())

library(tidyverse)
library(readxl)
library(phyloseq)
library(janitor)
library("writexl")

```
Reading in data with Ross code, this is relA. 
# Relative Abundance 
Read in coral ITS2 profiles: "coral"
```{r} 
#add metadata to symportal submission data
Symp_sub<-readxl::read_xlsx("MCL_SymPortal_submission_input.xlsx", skip = 1)
Metadata<-read.csv("MCL19_metadata_20200402.csv")
Metadata<-rename(Metadata, sample_name=UNIQUEID) #rename UNIQUEID column to sample_name
Symp_sub_Meta<-left_join(Symp_sub, Metadata, by="sample_name") # merge
#save in correct format:
write_xlsx(Symp_sub_Meta,"MCL_Symp_Metadata.xlsx")

sam0 <- readxl::read_xlsx("MCL_Symp_Metadata.xlsx") #Symportal metadata combined from above
sam1 <- as.matrix(sam0[, -1])
rownames(sam1) <- sam0$sample_name
sam <- sample_data(data.frame(sam1))

tax0 <- read_tsv(
  file  = "20201214_matsuda_MCL/its2_type_profiles/133_20201216_DBV_20201216T011417.profiles.relative.abund_and_meta.txt",
  n_max = 6) %>%
  dplyr::select(-2) %>% 
  gather(UID, value, -1) %>% 
  spread(1, value) %>%
  clean_names()

tax1 <- as.matrix(tax0[, -1], dimnames = list(tax0$uid, colnames(tax0[-1])))
rownames(tax1) <- tax0$uid
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file  = "20201214_matsuda_MCL/its2_type_profiles/133_20201216_DBV_20201216T011417.profiles.relative.abund_and_meta.txt") %>% 
  rename(sample_name = X2) %>%
  select(-1) %>%
  slice(7:n()) %>%
  mutate_at(2:ncol(.), as.numeric)
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

coral <- phyloseq(otu, tax, sam)
 


```
Read in coral post-QC sequence variants: "coralDIV"
```{r} 
sam0 <- read_xlsx("MCL_Symp_Metadata.xlsx")
rownames(sam0) <- sam0$sample_name
sam <- sample_data(data.frame(sam0))
taxnames <- read_tsv(
  file  = "20201214_matsuda_MCL/post_med_seqs/133_20201216_DBV_20201216T011417.seqs.relative.abund_only.txt",
  n_max = 0) %>%
  select(-1) %>%
  names(.)
tax0 <- data_frame(
  DIV = taxnames,
  clade = str_extract(DIV, "[A-Z]")
)
tax1 <- as.matrix(tax0)
rownames(tax1) <- tax0$DIV
tax <- tax_table(tax1)
otu0 <- read_tsv(
  file  = "20201214_matsuda_MCL/post_med_seqs/133_20201216_DBV_20201216T011417.seqs.relative.abund_and_meta.txt") %>%
  select(-1, -(3:33))
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)
coralDIV <- phyloseq(otu, tax, sam)
```

```{r}
save(coral, coralDIV, file = "data/coral_phyloseq.RData")
```
#Reading in data by ABSOLUTE abundances
so this is the same as above just by absolute

Profiles
```{r}
 
sam0 <- readxl::read_xlsx("MCL_Symp_Metadata.xlsx") #Symportal metadata combined from above
sam1 <- as.matrix(sam0[, -1])
rownames(sam1) <- sam0$sample_name
sam <- sample_data(data.frame(sam1))

tax0 <- read_tsv(
  file  = "20201214_matsuda_MCL/its2_type_profiles/133_20201216_DBV_20201216T011417.profiles.absolute.abund_and_meta.txt",
  n_max = 6) %>%
  dplyr::select(-2) %>% 
  gather(UID, value, -1) %>% 
  spread(1, value) %>%
  clean_names()

tax1 <- as.matrix(tax0[, -1], dimnames = list(tax0$uid, colnames(tax0[-1])))
rownames(tax1) <- tax0$uid
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file  = "20201214_matsuda_MCL/its2_type_profiles/133_20201216_DBV_20201216T011417.profiles.absolute.abund_and_meta.txt") %>% 
  rename(sample_name = X2) %>%
  select(-1) %>%
  slice(7:n()) %>%
  mutate_at(2:ncol(.), as.numeric)
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

coral_absolutePro <- phyloseq(otu, tax, sam)
```
DIVs absolute
```{r}

taxnames <- read_tsv(
  file  = "20201214_matsuda_MCL/post_med_seqs/133_20201216_DBV_20201216T011417.seqs.absolute.abund_only.txt",
  n_max = 0) %>%
  select(-1) %>%
  names(.)
tax0 <- data_frame(
  DIV = taxnames,
  clade = str_extract(DIV, "[A-Z]")
)
tax1 <- as.matrix(tax0)
rownames(tax1) <- tax0$DIV
tax <- tax_table(tax1)
otu0 <- read_tsv(
  file  = "20201214_matsuda_MCL/post_med_seqs/133_20201216_DBV_20201216T011417.seqs.absolute.abund_and_meta.txt") %>%
  select(-1, -(3:33))
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)
coral_Absolute_DIV <- phyloseq(otu, tax, sam)
```
Save as an obj
```{r}
save(coral_absolutePro, coral_Absolute_DIV, file = "data/Absolute_coral_phyloseq.RData")
```

#Analysis (RCunning Script) REL Abundance -  
```{r} 
library(tidyverse)
library(janitor)
library(phyloseq)  # source('http://bioconductor.org/biocLite.R'); biocLite('phyloseq')
library(zoo)
library(stringr)
library(vegan)
library(multcompView)
library("ggpubr")

# Load data (see data_exploration.Rmd)
load("data/coral_phyloseq.RData")
```
Hey what does this do?
```{r}
coral2 <- coral %>%
  subset_samples(!is.na(host_species))
coralDIV2 <- coralDIV %>% 
  subset_samples(!is.na(host_species))

# HERE YOU MAKE RELA DATA ACTUALLY OUT OF 100% 
# Transform to relative abundance
coral2 <- transform_sample_counts(coral2, function(x) 100 * x/sum(x))
coralDIV2 <- transform_sample_counts(coralDIV2, function(x) 100 * x/sum(x))

```

Monster all data vis (not helpful)
```{r, fig.width = 10, fig.height = 40}
# Plot ITS2 profiles for each coral sample by species and site
plot_bar(coral, fill = "its2_type_profile") +
  facet_wrap(~ host_genus + host_species, ncol = 6, scales = "free") +
  #theme(legend.position = "none") +
  geom_bar(stat = "identity")
# Plot all post-MED sequences
plot_bar(coralDIV2, fill = "DIV") +
  facet_wrap(~ host_genus + host_species, scales = "free") +
  #theme(legend.position = "none") +
  geom_bar(stat = "identity")
# Glom all post-MED sequences by clade:
divclades <- coralDIV2 %>%
  tax_glom(taxrank = "clade") %>%                # agglomerate at clade level
  psmelt() %>%                                         # Melt to long format
  arrange(clade)                                      # Sort data frame alphabetically by clade
ggplot(divclades, aes(x = Sample, y = Abundance, fill = clade)) +
  facet_wrap(~ host_genus + host_species, scales = "free") +
  geom_bar(stat = "identity") +
  labs(title=NULL, x = NULL, y = "Relative abundance")
```

Data wrangle: remove samples with under 5k 
```{r}
#lets see what is up with the low samps

LowSamps<-readxl::read_xlsx("20201214_matsuda_MCL/post_med_seqs/133_20201216_DBV_20201216T011417.seqs.absolute.meta_only.xlsx")

LowSamps$post_taxa_id_absolute_symbiodiniaceae_seqs_log<-log10(LowSamps$post_taxa_id_absolute_symbiodiniaceae_seqs)
hist(LowSamps$post_taxa_id_absolute_symbiodiniaceae_seqs_log, breaks=20)

```
Look at the low samples: no patterns
```{r}
sample_names(coralDIV2) #pring sample names

#look at NTCs
#Negative Controls
  NTCtest <- subset_samples(coralDIV2, sample_name =="NTC"| sample_name =="NTC2") #subset multiple samples
   NTCtest.prune <- prune_taxa(taxa_sums(NTCtest) >0, NTCtest)
     plot_bar(NTCtest.prune,fill = "DIV")+
      geom_bar(aes(color=DIV, fill=DIV), stat="identity", position="stack")
     
#Samples under 2000 hits 
LOWtest <- subset_samples(coralDIV2, sample_name =="S6"| sample_name =="G7"|sample_name =="Q11"|sample_name =="G8"|sample_name =="B13"|sample_name =="B6"|sample_name =="C14") #subset multiple samples
   LOWtest.prune <- prune_taxa(taxa_sums(LOWtest) >0, LOWtest) # prune all 0s
     
   plot_bar(LOWtest.prune,fill = "DIV")+                     # plot DIVS
    geom_bar(aes(color=DIV, fill=DIV), stat="identity", position="stack")
     
   plot_bar(LOWtest.prune,fill = "clade")+                     # plot Clades
      geom_bar(aes(color=clade, fill=clade), stat="identity", position="stack")
     
```
 
Remove low samples from the datasets
```{r} 
#DIVs
to_remove <- c("NTC", "NTC2", "S6", "G7","Q11","G8", "B13","B6") #make list of samples to remove with less than 2000 seqs
coralDIV2.prune <- prune_samples(!(sample_names(coralDIV2) %in% to_remove), coralDIV2) #remove
#sample_names(coralDIV2.prune) # check to see they are removed

#Pros
to_remove <- c("NTC", "NTC2", "S6", "G7","Q11","G8", "B13","B6") #make list of samples to remove with less than 2000 seqs
coral2.prune <- prune_samples(!(sample_names(coral2) %in% to_remove), coral2) #remove
#sample_names(coral2.prune) # check to see they are removed

```

Subset by colony DIV, data setup
```{r}
sample_variables(coralDIV2.prune) #what are the variables

Mcap_970 <- subset_samples(coralDIV2.prune, TagID =="970") #Subset by colony  
Mcap_965 <- subset_samples(coralDIV2.prune, TagID =="965") #Subset by colony  
Mcap_969 <- subset_samples(coralDIV2.prune, TagID =="969") #Subset by colony  
Mcap_972 <- subset_samples(coralDIV2.prune, TagID =="972") #Subset by colony  
Mcap_971 <- subset_samples(coralDIV2.prune, TagID =="971") #Subset by colony 
Mcap_968 <- subset_samples(coralDIV2.prune, TagID =="968") #Subset by colony 
Mcap_966 <- subset_samples(coralDIV2.prune, TagID =="966") #Subset by colony 
Mcap_978 <- subset_samples(coralDIV2.prune, TagID =="978") #Subset by colony 
Mcap_963 <- subset_samples(coralDIV2.prune, TagID =="963") #Subset by colony 
Mcap_961 <- subset_samples(coralDIV2.prune, TagID =="961") #Subset by colony 
Mcap_981 <- subset_samples(coralDIV2.prune, TagID =="981") #Subset by colony 
Mcap_967 <- subset_samples(coralDIV2.prune, TagID =="967") #Subset by colony 
Mcap_983 <- subset_samples(coralDIV2.prune, TagID =="983") #Subset by colony 
Mcap_974 <- subset_samples(coralDIV2.prune, TagID =="974") #Subset by colony 
Mcap_984 <- subset_samples(coralDIV2.prune, TagID =="984") #Subset by colony 
Mcap_962 <- subset_samples(coralDIV2.prune, TagID =="962") #Subset by colony 
Mcap_957 <- subset_samples(coralDIV2.prune, TagID =="957") #Subset by colony 
Mcap_945 <- subset_samples(coralDIV2.prune, TagID =="945") #Subset by colony 
Mcap_960 <- subset_samples(coralDIV2.prune, TagID =="960") #Subset by colony 
Mcap_976 <- subset_samples(coralDIV2.prune, TagID =="976") #Subset by colony 
Mcap_985 <- subset_samples(coralDIV2.prune, TagID =="985") #Subset by colony 
Mcap_964 <- subset_samples(coralDIV2.prune, TagID =="964") #Subset by colony 
Mcap_959 <- subset_samples(coralDIV2.prune, TagID =="959") #Subset by colony 
Mcap_980 <- subset_samples(coralDIV2.prune, TagID =="980") #Subset by colony 
  
```
Plots DIVS
```{r} 

#try to transform samp counts

#for the legend
 plot_bar(Mcap_970,fill = "DIV")+
      geom_bar(aes(color=DIV, fill=DIV), stat="identity", position="stack")

Mcap_970_plot<-plot_bar(Mcap_970, "Sample_name", fill="DIV", title="Mcap_970")+
   theme(legend.position="none");Mcap_970_plot
Mcap_965_plot<-plot_bar(Mcap_965, "Sample_name", fill="DIV", title="Mcap_965")+
   theme(legend.position="none");Mcap_965_plot
Mcap_969_plot<-plot_bar(Mcap_969, "Sample_name", fill="DIV", title="Mcap_969")+
   theme(legend.position="none");Mcap_969_plot
Mcap_972_plot<-plot_bar(Mcap_972, "Sample_name", fill="DIV", title="Mcap_972")+
   theme(legend.position="none");Mcap_972_plot
Mcap_971_plot<-plot_bar(Mcap_971, "Sample_name", fill="DIV", title="Mcap_971")+
   theme(legend.position="none");Mcap_971_plot
Mcap_968_plot<-plot_bar(Mcap_968, "Sample_name", fill="DIV", title="Mcap_968")+
   theme(legend.position="none");Mcap_968_plot
Mcap_966_plot<-plot_bar(Mcap_966, "Sample_name", fill="DIV", title="Mcap_966")+
   theme(legend.position="none");Mcap_966_plot
Mcap_978_plot<-plot_bar(Mcap_978, "Sample_name", fill="DIV", title="Mcap_978")+
   theme(legend.position="none");Mcap_978_plot
Mcap_963_plot<-plot_bar(Mcap_963, "Sample_name", fill="DIV", title="Mcap_963")+
   theme(legend.position="none");Mcap_963_plot
Mcap_961_plot<-plot_bar(Mcap_961, "Sample_name", fill="DIV", title="Mcap_961")+
   theme(legend.position="none");Mcap_961_plot
Mcap_981_plot<-plot_bar(Mcap_981, "Sample_name", fill="DIV", title="Mcap_981")+
   theme(legend.position="none");Mcap_981_plot
Mcap_967_plot<-plot_bar(Mcap_967, "Sample_name", fill="DIV", title="Mcap_967")+
   theme(legend.position="none");Mcap_967_plot
Mcap_983_plot<-plot_bar(Mcap_983, "Sample_name", fill="DIV", title="Mcap_983")+
   theme(legend.position="none");Mcap_983_plot
Mcap_974_plot<-plot_bar(Mcap_974, "Sample_name", fill="DIV", title="Mcap_974")+
   theme(legend.position="none");Mcap_974_plot
Mcap_984_plot<-plot_bar(Mcap_984, "Sample_name", fill="DIV", title="Mcap_984")+
   theme(legend.position="none");Mcap_984_plot
Mcap_962_plot<-plot_bar(Mcap_962, "Sample_name", fill="DIV", title="Mcap_962")+
   theme(legend.position="none");Mcap_962_plot
Mcap_957_plot<-plot_bar(Mcap_957, "Sample_name", fill="DIV", title="Mcap_957")+
   theme(legend.position="none");Mcap_957_plot
Mcap_945_plot<-plot_bar(Mcap_945, "Sample_name", fill="DIV", title="Mcap_945")+
   theme(legend.position="none");Mcap_945_plot
Mcap_960_plot<-plot_bar(Mcap_960, "Sample_name", fill="DIV", title="Mcap_960")+
   theme(legend.position="none");Mcap_960_plot
Mcap_976_plot<-plot_bar(Mcap_976, "Sample_name", fill="DIV", title="Mcap_976")+
   theme(legend.position="none");Mcap_976_plot
Mcap_985_plot<-plot_bar(Mcap_985, "Sample_name", fill="DIV", title="Mcap_985")+
   theme(legend.position="none");Mcap_985_plot
Mcap_964_plot<-plot_bar(Mcap_964, "Sample_name", fill="DIV", title="Mcap_964")+
   theme(legend.position="none");Mcap_964_plot
Mcap_985_plot<-plot_bar(Mcap_985, "Sample_name", fill="DIV", title="Mcap_985")+
   theme(legend.position="none");Mcap_985_plot
Mcap_959_plot<-plot_bar(Mcap_959, "Sample_name", fill="DIV", title="Mcap_959")+
   theme(legend.position="none");Mcap_959_plot
Mcap_980_plot<-plot_bar(Mcap_980, "Sample_name", fill="DIV", title="Mcap_980")+
   theme(legend.position="none");Mcap_980_plot


Mcap_DIV_plot1 <- ggarrange(Mcap_970_plot, Mcap_965_plot,Mcap_969_plot,Mcap_972_plot, Mcap_971_plot,Mcap_968_plot,Mcap_966_plot,Mcap_978_plot,
                    #labels = c("A", "B", "C","D","E","F"),
                    ncol = 4, nrow = 2);Mcap_DIV_plot1

Mcap_DIV_plot2 <- ggarrange(Mcap_963_plot, Mcap_961_plot,Mcap_981_plot,Mcap_967_plot,
Mcap_983_plot,Mcap_974_plot,Mcap_984_plot,Mcap_962_plot,
                    #labels = c("A", "B", "C","D","E","F"),
                    ncol = 4, nrow = 2);Mcap_DIV_plot2

Mcap_DIV_plot3 <- ggarrange(Mcap_957_plot,Mcap_945_plot,Mcap_960_plot,Mcap_976_plot,
Mcap_985_plot,Mcap_964_plot,Mcap_985_plot,Mcap_964_plot,Mcap_985_plot,Mcap_959_plot,Mcap_980_plot,
                    #labels = c("A", "B", "C","D","E","F"),
                    ncol = 4, nrow = 3);Mcap_DIV_plot3

```

PROFILES
Subset by colony PROFILE, data setup
```{r} 
 
library("RColorBrewer")
getPalette = colorRampPalette(brewer.pal(8, "Dark2"))

speciesList = unique(tax_table(coral2.prune)[,"its2_type_profile"])
speciesPalette = getPalette(length(speciesList))
names(speciesPalette) = speciesList

#scale_color_manual(values=speciesPalette)
#scale_fill_manual(values= speciesPalette)

#this works but you need better pallet color = grDevices::colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]





sample_variables(coral2.prune) #what are the variables

Mcap_970_Pro <- subset_samples(coral2.prune, TagID =="970") #Subset by colony  
Mcap_965_Pro <- subset_samples(coral2.prune, TagID =="965") #Subset by colony  
Mcap_969_Pro <- subset_samples(coral2.prune, TagID =="969") #Subset by colony  
Mcap_972_Pro <- subset_samples(coral2.prune, TagID =="972") #Subset by colony  
Mcap_971_Pro <- subset_samples(coral2.prune, TagID =="971") #Subset by colony 
Mcap_968_Pro <- subset_samples(coral2.prune, TagID =="968") #Subset by colony 
Mcap_966_Pro <- subset_samples(coral2.prune, TagID =="966") #Subset by colony 
Mcap_978_Pro <- subset_samples(coral2.prune, TagID =="978") #Subset by colony 
Mcap_963_Pro <- subset_samples(coral2.prune, TagID =="963") #Subset by colony 
Mcap_961_Pro <- subset_samples(coral2.prune, TagID =="961") #Subset by colony 
Mcap_981_Pro <- subset_samples(coral2.prune, TagID =="981") #Subset by colony 
Mcap_967_Pro <- subset_samples(coral2.prune, TagID =="967") #Subset by colony 
Mcap_983_Pro <- subset_samples(coral2.prune, TagID =="983") #Subset by colony 
Mcap_974_Pro <- subset_samples(coral2.prune, TagID =="974") #Subset by colony 
Mcap_984_Pro <- subset_samples(coral2.prune, TagID =="984") #Subset by colony 
Mcap_962_Pro <- subset_samples(coral2.prune, TagID =="962") #Subset by colony 
Mcap_957_Pro <- subset_samples(coral2.prune, TagID =="957") #Subset by colony 
Mcap_945_Pro <- subset_samples(coral2.prune, TagID =="945") #Subset by colony 
Mcap_960_Pro <- subset_samples(coral2.prune, TagID =="960") #Subset by colony 
Mcap_976_Pro <- subset_samples(coral2.prune, TagID =="976") #Subset by colony 
Mcap_985_Pro <- subset_samples(coral2.prune, TagID =="985") #Subset by colony 
Mcap_964_Pro <- subset_samples(coral2.prune, TagID =="964") #Subset by colony 
Mcap_959_Pro <- subset_samples(coral2.prune, TagID =="959") #Subset by colony 
Mcap_980_Pro <- subset_samples(coral2.prune, TagID =="980") #Subset by colony 
  
```
Plots PRO
```{r}
#for the legend
 plot_bar(Mcap_970_Pro,fill = "its2_type_profile")+
      geom_bar(aes(color=its2_type_profile, fill=its2_type_profile), stat="identity", position="stack")


Mcap_970_PRO_plot<-plot_bar(Mcap_970_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_970_Pro")+
   theme(legend.position="none");Mcap_970_PRO_plot
Mcap_965_PRO_plot<-plot_bar(Mcap_965_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_965_Pro")+
   theme(legend.position="none");Mcap_965_PRO_plot
Mcap_969_PRO_plot<-plot_bar(Mcap_969_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_969_Pro")+
   theme(legend.position="none");Mcap_969_PRO_plot
Mcap_972_PRO_plot<-plot_bar(Mcap_972_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_972_Pro")+
   theme(legend.position="none");Mcap_972_PRO_plot
Mcap_971_PRO_plot<-plot_bar(Mcap_971_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_971_Pro")+
   theme(legend.position="none");Mcap_971_PRO_plot
Mcap_968_PRO_plot<-plot_bar(Mcap_968_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_968_Pro")+
   theme(legend.position="none");Mcap_968_PRO_plot
Mcap_966_PRO_plot<-plot_bar(Mcap_966_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_966_Pro")+
   theme(legend.position="none");Mcap_966_PRO_plot
Mcap_978_PRO_plot<-plot_bar(Mcap_978_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_978_Pro")+
   theme(legend.position="none");Mcap_978_PRO_plot
Mcap_963_PRO_plot<-plot_bar(Mcap_963_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_963_Pro")+
   theme(legend.position="none");Mcap_963_PRO_plot
Mcap_961_PRO_plot<-plot_bar(Mcap_961_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_961_Pro")+
   theme(legend.position="none");Mcap_961_PRO_plot
Mcap_981_PRO_plot<-plot_bar(Mcap_981_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_981_Pro")+
   theme(legend.position="none");Mcap_981_PRO_plot
Mcap_967_PRO_plot<-plot_bar(Mcap_967_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_967_Pro")+
   theme(legend.position="none");Mcap_967_PRO_plot
Mcap_983_PRO_plot<-plot_bar(Mcap_983_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_983_Pro")+
   theme(legend.position="none");Mcap_983_PRO_plot
Mcap_974_PRO_plot<-plot_bar(Mcap_974_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_974_Pro")+
   theme(legend.position="none");Mcap_974_PRO_plot
Mcap_984_PRO_plot<-plot_bar(Mcap_984_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_984_Pro")+
   theme(legend.position="none");Mcap_984_PRO_plot
Mcap_962_PRO_plot<-plot_bar(Mcap_962_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_962_Pro")+
   theme(legend.position="none");Mcap_962_PRO_plot
Mcap_957_PRO_plot<-plot_bar(Mcap_957_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_957_Pro")+
   theme(legend.position="none");Mcap_957_PRO_plot
Mcap_945_PRO_plot<-plot_bar(Mcap_945_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_945_Pro")+
   theme(legend.position="none");Mcap_945_PRO_plot
Mcap_960_PRO_plot<-plot_bar(Mcap_960_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_960_Pro")+
   theme(legend.position="none");Mcap_960_PRO_plot
Mcap_976_PRO_plot<-plot_bar(Mcap_976_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_976_Pro")+
   theme(legend.position="none");Mcap_976_PRO_plot
Mcap_985_PRO_plot<-plot_bar(Mcap_985_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_985_Pro")+
   theme(legend.position="none");Mcap_985_PRO_plot
Mcap_964_PRO_plot<-plot_bar(Mcap_964_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_964_Pro")+
   theme(legend.position="none");Mcap_964_PRO_plot
Mcap_985_PRO_plot<-plot_bar(Mcap_985_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_985_Pro")+
   theme(legend.position="none");Mcap_985_PRO_plot
Mcap_959_PRO_plot<-plot_bar(Mcap_959_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_959_Pro")+
   theme(legend.position="none");Mcap_959_PRO_plot
Mcap_980_PRO_plot<-plot_bar(Mcap_980_Pro, "Sample_name", fill="its2_type_profile", title="Mcap_980_Pro")+
   theme(legend.position="none");Mcap_980_PRO_plot


Mcap_DIV_PRO_plot1 <- ggarrange(Mcap_970_PRO_plot, Mcap_965_PRO_plot,Mcap_969_PRO_plot,Mcap_972_PRO_plot, Mcap_971_PRO_plot,Mcap_968_PRO_plot,Mcap_966_PRO_plot,Mcap_978_PRO_plot,
                    #labels = c("A", "B", "C","D","E","F"),
                    ncol = 4, nrow = 2);Mcap_DIV_PRO_plot1

Mcap_DIV_PRO_plot2 <- ggarrange(Mcap_963_PRO_plot, Mcap_961_PRO_plot,Mcap_981_PRO_plot,Mcap_967_PRO_plot,
Mcap_983_PRO_plot,Mcap_974_PRO_plot,Mcap_984_PRO_plot,Mcap_962_PRO_plot,
                    #labels = c("A", "B", "C","D","E","F"),
                    ncol = 4, nrow = 2);Mcap_DIV_PRO_plot2

Mcap_DIV_PRO_plot3 <- ggarrange(Mcap_957_PRO_plot,Mcap_945_PRO_plot,Mcap_960_PRO_plot,Mcap_976_PRO_plot,
Mcap_985_PRO_plot,Mcap_964_PRO_plot,Mcap_985_PRO_plot,Mcap_964_PRO_plot,Mcap_985_PRO_plot,Mcap_959_PRO_plot,Mcap_980_PRO_plot,
                    #labels = c("A", "B", "C","D","E","F"),
                    ncol = 4, nrow = 3);Mcap_DIV_PRO_plot3

```
Plots CLADE
```{r} 

#scale_color_manual(values=speciesPalette)
#scale_fill_manual(values= speciesPalette)
 Mcap_970_clade_plot<-plot_bar(Mcap_970_Pro, "Sample_name", fill="clade", title="Mcap_970_clade");Mcap_970_clade_plot


Mcap_970_clade_plot<-plot_bar(Mcap_970_Pro, "Sample_name", fill="clade", title="Mcap_970_clade")+
   theme(legend.position="none");Mcap_970_clade_plot
Mcap_965_clade_plot<-plot_bar(Mcap_965_Pro, "Sample_name", fill="clade", title="Mcap_965_clade")+
   theme(legend.position="none");Mcap_965_clade_plot
Mcap_969_clade_plot<-plot_bar(Mcap_969_Pro, "Sample_name", fill="clade", title="Mcap_969_clade")+
   theme(legend.position="none");Mcap_969_clade_plot
Mcap_972_clade_plot<-plot_bar(Mcap_972_Pro, "Sample_name", fill="clade", title="Mcap_972_clade")+
   theme(legend.position="none");Mcap_972_clade_plot
Mcap_971_clade_plot<-plot_bar(Mcap_971_Pro, "Sample_name", fill="clade", title="Mcap_971_clade")+
   theme(legend.position="none");Mcap_971_clade_plot
Mcap_968_clade_plot<-plot_bar(Mcap_968_Pro, "Sample_name", fill="clade", title="Mcap_968_clade")+
   theme(legend.position="none");Mcap_968_clade_plot
Mcap_966_clade_plot<-plot_bar(Mcap_966_Pro, "Sample_name", fill="clade", title="Mcap_966_clade")+
   theme(legend.position="none");Mcap_966_clade_plot
Mcap_978_clade_plot<-plot_bar(Mcap_978_Pro, "Sample_name", fill="clade", title="Mcap_978_clade")+
   theme(legend.position="none");Mcap_978_clade_plot
Mcap_963_clade_plot<-plot_bar(Mcap_963_Pro, "Sample_name", fill="clade", title="Mcap_963_clade")+
   theme(legend.position="none");Mcap_963_clade_plot
Mcap_961_clade_plot<-plot_bar(Mcap_961_Pro, "Sample_name", fill="clade", title="Mcap_961_clade")+
   theme(legend.position="none");Mcap_961_clade_plot
Mcap_981_clade_plot<-plot_bar(Mcap_981_Pro, "Sample_name", fill="clade", title="Mcap_981_clade")+
   theme(legend.position="none");Mcap_981_clade_plot
Mcap_967_clade_plot<-plot_bar(Mcap_967_Pro, "Sample_name", fill="clade", title="Mcap_967_clade")+
   theme(legend.position="none");Mcap_967_clade_plot
Mcap_983_clade_plot<-plot_bar(Mcap_983_Pro, "Sample_name", fill="clade", title="Mcap_983_clade")+
   theme(legend.position="none");Mcap_983_clade_plot
Mcap_974_clade_plot<-plot_bar(Mcap_974_Pro, "Sample_name", fill="clade", title="Mcap_974_clade")+
   theme(legend.position="none");Mcap_974_clade_plot
Mcap_984_clade_plot<-plot_bar(Mcap_984_Pro, "Sample_name", fill="clade", title="Mcap_984_clade")+
   theme(legend.position="none");Mcap_984_clade_plot
Mcap_962_clade_plot<-plot_bar(Mcap_962_Pro, "Sample_name", fill="clade", title="Mcap_962_clade")+
   theme(legend.position="none");Mcap_962_clade_plot
Mcap_957_clade_plot<-plot_bar(Mcap_957_Pro, "Sample_name", fill="clade", title="Mcap_957_clade")+
   theme(legend.position="none");Mcap_957_clade_plot
Mcap_945_clade_plot<-plot_bar(Mcap_945_Pro, "Sample_name", fill="clade", title="Mcap_945_clade")+
   theme(legend.position="none");Mcap_945_clade_plot
Mcap_960_clade_plot<-plot_bar(Mcap_960_Pro, "Sample_name", fill="clade", title="Mcap_960_clade")+
   theme(legend.position="none");Mcap_960_clade_plot
Mcap_976_clade_plot<-plot_bar(Mcap_976_Pro, "Sample_name", fill="clade", title="Mcap_976_clade")+
   theme(legend.position="none");Mcap_976_clade_plot
Mcap_985_clade_plot<-plot_bar(Mcap_985_Pro, "Sample_name", fill="clade", title="Mcap_985_clade")+
   theme(legend.position="none");Mcap_985_clade_plot
Mcap_964_clade_plot<-plot_bar(Mcap_964_Pro, "Sample_name", fill="clade", title="Mcap_964_clade")+
   theme(legend.position="none");Mcap_964_clade_plot
Mcap_985_clade_plot<-plot_bar(Mcap_985_Pro, "Sample_name", fill="clade", title="Mcap_985_clade")+
   theme(legend.position="none");Mcap_985_clade_plot
Mcap_959_clade_plot<-plot_bar(Mcap_959_Pro, "Sample_name", fill="clade", title="Mcap_959_clade")+
   theme(legend.position="none");Mcap_959_clade_plot
Mcap_980_clade_plot<-plot_bar(Mcap_980_Pro, "Sample_name", fill="clade", title="Mcap_980_clade")+
   theme(legend.position="none");Mcap_980_clade_plot


Mcap_DIV_clade_plot1 <- ggarrange(Mcap_970_clade_plot, Mcap_965_clade_plot,Mcap_969_clade_plot,Mcap_972_clade_plot, Mcap_971_clade_plot,Mcap_968_clade_plot,Mcap_966_clade_plot,Mcap_978_clade_plot,
                    #labels = c("A", "B", "C","D","E","F"),
                    ncol = 4, nrow = 2);Mcap_DIV_clade_plot1

Mcap_DIV_clade_plot2 <- ggarrange(Mcap_963_clade_plot, Mcap_961_clade_plot,Mcap_981_clade_plot,Mcap_967_clade_plot,
Mcap_983_clade_plot,Mcap_974_clade_plot,Mcap_984_clade_plot,Mcap_962_clade_plot,
                    #labels = c("A", "B", "C","D","E","F"),
                    ncol = 4, nrow = 2);Mcap_DIV_clade_plot2

Mcap_DIV_clade_plot3 <- ggarrange(Mcap_957_clade_plot,Mcap_945_clade_plot,Mcap_960_clade_plot,Mcap_976_clade_plot,
Mcap_985_clade_plot,Mcap_964_clade_plot,Mcap_985_clade_plot,Mcap_964_clade_plot,Mcap_985_clade_plot,Mcap_959_clade_plot,Mcap_980_clade_plot,
                    #labels = c("A", "B", "C","D","E","F"),
                    ncol = 4, nrow = 3);Mcap_DIV_clade_plot3
```



big fig
```{r} 
theme_set(theme_classic())
library(ggpubr)

library(ggarrange)


figureMCL1 <- ggarrange(Mcap_970_clade_plot, Mcap_965_clade_plot, Mcap_969_clade_plot,Mcap_972_clade_plot, 
                               Mcap_970_PRO_plot, Mcap_965_PRO_plot, Mcap_969_PRO_plot, Mcap_972_PRO_plot, 
                               Mcap_970_plot, Mcap_965_plot, Mcap_969_plot, Mcap_972_plot, 
                    ncol = 4, nrow = 3);figureMCL1

figureMCL2 <- ggarrange(Mcap_971_clade_plot,Mcap_968_clade_plot,Mcap_966_clade_plot,Mcap_978_clade_plot, 
                        Mcap_971_PRO_plot,Mcap_968_PRO_plot,Mcap_966_PRO_plot,Mcap_978_PRO_plot, 
                        Mcap_971_plot,Mcap_968_plot,Mcap_966_plot,Mcap_978_plot, 
                    ncol = 4, nrow = 3);figureMCL2

figureMCL3 <- ggarrange(Mcap_963_clade_plot, Mcap_961_clade_plot,Mcap_981_clade_plot,Mcap_967_clade_plot,
                        Mcap_963_PRO_plot, Mcap_961_PRO_plot,Mcap_981_PRO_plot,Mcap_967_PRO_plot,
                        Mcap_963_plot, Mcap_961_plot,Mcap_981_plot,Mcap_967_plot,
                    ncol = 4, nrow = 3);figureMCL3

figureMCL4 <- ggarrange(Mcap_983_clade_plot, Mcap_974_clade_plot,Mcap_984_clade_plot,Mcap_962_clade_plot, 
                        Mcap_983_PRO_plot, Mcap_974_PRO_plot,Mcap_984_PRO_plot,Mcap_962_PRO_plot, 
                        Mcap_983_plot,Mcap_974_plot,Mcap_984_plot,Mcap_962_plot, 
                    ncol = 4, nrow = 3);figureMCL4

figureMCL5 <- ggarrange(Mcap_957_clade_plot, Mcap_945_clade_plot,Mcap_960_clade_plot,Mcap_976_clade_plot,
                        Mcap_957_PRO_plot,Mcap_945_PRO_plot,Mcap_960_PRO_plot,Mcap_976_PRO_plot,
                        Mcap_957_plot,Mcap_945_plot,Mcap_960_plot,Mcap_976_plot,
                    ncol = 4, nrow = 3);figureMCL5


figureMCL6 <- ggarrange(Mcap_985_clade_plot, Mcap_964_clade_plot, Mcap_959_clade_plot,Mcap_980_clade_plot,
                        Mcap_985_PRO_plot, Mcap_964_PRO_plot, Mcap_959_PRO_plot,Mcap_980_PRO_plot,
                        Mcap_985_plot,Mcap_964_plot,Mcap_959_plot,Mcap_980_plot,
                    ncol = 4, nrow = 3);figureMCL6



```


Ordination OLD
```{r}
plot_ordination(coralDIV2.prune, ordinate(coralDIV2.prune, "MDS"), color = "TagID") + geom_point(size = 5)
plot_heatmap(coralDIV2.prune, "NMDS", "bray", "TagID", "DIV")

GP.ord <- ordinate(coralDIV2.prune, "NMDS", "bray")
p1 = plot_ordination(coralDIV2.prune, GP.ord, type="samples", color="TagID", title="taxa")
print(p1)

p2 = plot_ordination(coralDIV2.prune, GP.ord, type="samples", color="TagID", shape="TagID") 
p2 + geom_polygon(aes(fill=SampleType)) + geom_point(size=5) + ggtitle("samples")
```


# PERMANOVA coralDIV2.prune
```{r}            
# Sp.colors <- c("Montipora_capitata"= "#D43F3AFF","Porites_compressa"="#EEA236FF","Pavona_varians"="#5CB85CFF","Pocillopora_acuta"="#46B8DAFF", "High"="darkRed","Ambient"="navyBlue")

coralDIV2.prune_stats<- coralDIV2.prune #make a copy
otu_table(coralDIV2.prune_stats)[1:5, 1:5] #check rela worked

#bray curtis presence-absense and abundance
 
  coralDIV2.prune_stats = prune_taxa(taxa_sums(coralDIV2.prune_stats) > 0, coralDIV2.prune_stats) #this removes any OTU with 0s

#bray curtis presence-absense and abundance

#all speices
set.seed(300)

#make bray curtis data matrix
bc.all <- phyloseq::distance(coralDIV2.prune_stats, method = "bray")
  samp.df <- as(sample_data(coralDIV2.prune_stats), "data.frame") #sample df
  
  samp.df$TagID<-as.factor(samp.df$TagID)
    samp.df$Land_Ocean<-as.factor(samp.df$Land_Ocean)
    samp.df$SampLoc<-as.factor(samp.df$SampLoc)

  
#adonis test
adonis(bc.all ~ TagID*SampLoc, data = samp.df) #all sig
    

# Homogeneity of dispersion test
beta.colony <- betadisper(bc.all, samp.df$TagID)
perm<-permutest(beta.colony, pairwise = T) 
(bc.all.HSD <- TukeyHSD(beta.colony)) #do you need?
plot(bc.all.HSD)


#Ordination NMDS for all species
set.seed(30)
ord.DIV_bc.all <- ordinate(coralDIV2.prune_stats, "NMDS", "bray", trymax = 300) 
stressplot(ord.DIV_bc.all)
ord.DIV_bc.all <- as.data.frame(cbind(vegan::scores(ord.DIV_bc.all, display="sites"))) #make df
ord.DIV_bc.all$TagID <- samp.df$TagID
ord.DIV_bc.all$SampLoc <- samp.df$SampLoc

ggplot(ord.DIV_bc.all, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = TagID), size = 4,show.legend=F) +
  #scale_color_manual(values=Sp.colors)+
  # geom_text(label = rownames(Clade), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = TagID), linetype = 2,show.legend=F) +
  ggtitle("NMDS its2 Bray Curtis ") +
  theme_classic()
#ggsave("bc_all.pdf")

ggplot(ord.DIV_bc.all, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = SampLoc), size = 4,show.legend=T) +
  #scale_color_manual(values=Sp.colors)+
  # geom_text(label = rownames(Clade), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = SampLoc), linetype = 2,show.legend=T) +
  ggtitle("NMDS its2 Bray Curtis ") +
  theme_classic()
#ggsave("bc_all.pdf")



#bray curtis presence-absense and abundance

#all speices
set.seed(30)

#make bray curtis data matrix
bc.all <- phyloseq::distance(DIV_RelA_stats, method = "bray")
  samp.df <- as(sample_data(DIV_RelA_stats), "data.frame") #sample df
#adonis test
adonis(bc.all ~ Species*Time.Point*Treatment, data = samp.df)
    

# Homogeneity of dispersion test
betaAll <- betadisper(bc.all, samp.df$Species)
permutest(betaAll, pairwise = T) 
(bc.all.HSD <- TukeyHSD(betaAll)) #do you need?
plot(bc.all.HSD)


#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats <- ordinate(DIV_RelA_stats, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats)
scores.ord.DIV_RelA_stats <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats, display="sites"))) #make df
scores.ord.DIV_RelA_stats$Treatment <- samp.df$Treatment
scores.ord.DIV_RelA_stats$Species <- samp.df$Species
scores.ord.DIV_RelA_stats$Clade <- samp.df$Clade
scores.ord.DIV_RelA_stats$Time.Point <- samp.df$Time.Point

ggplot(scores.ord.DIV_RelA_stats, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Species), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  #stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("NMDS its2 Bray Curtis") +
  theme_classic()
#ggsave("bc_all.pdf")

ggplot(scores.ord.DIV_RelA_stats, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Clade, shape=Species), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  #stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("NMDS its2 Bray Curtis") +
  theme_classic()
#ggsave("bc_all.pdf")


#BY COLONY

#945 ####
DIV_RelA_stats_945<-subset_samples(coralDIV2.prune_stats, TagID=="945")
  DIV_RelA_stats_945 = prune_taxa(taxa_sums(DIV_RelA_stats_945) > 0, DIV_RelA_stats_945) #this removes any OTU with 0s
  samp.df_945 <- as(sample_data(DIV_RelA_stats_945), "data.frame") #sample df

#all speices
set.seed(30)

#make bray curtis data matrix
bc.945 <- phyloseq::distance(coralDIV2.prune_stats, method = "bray")
  samp.df_945 <- as(sample_data(coralDIV2.prune_stats), "data.frame") #sample df
#adonis test
adonis(bc.945 ~ SampLoc, data = samp.df_945)
    
# Homogeneity of dispersion test
betaAll <- betadisper(bc.all, samp.df$Species)
permutest(betaAll, pairwise = T) 
(bc.all.HSD <- TukeyHSD(betaAll)) #do you need?
plot(bc.all.HSD)

#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats.945 <- ordinate(DIV_RelA_stats_945, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats.945)
ord.DIV_RelA_stats.945 <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats.945, display="sites"))) #make df
ord.DIV_RelA_stats.945$SampLoc <- samp.df_945$SampLoc
ord.DIV_RelA_stats.945$sample_name <- samp.df_945$sample_name

ggplot(ord.DIV_RelA_stats.945, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = SampLoc, shape=SampLoc), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  ggtitle("NMDS its2 Bray Curtis 945") +
  theme_classic() 
#ggsave("bc_all.pdf")

#960 ####
DIV_RelA_stats_960<-subset_samples(coralDIV2.prune_stats, TagID=="960")
  DIV_RelA_stats_960 = prune_taxa(taxa_sums(DIV_RelA_stats_960) > 0, DIV_RelA_stats_960) #this removes any OTU with 0s
  samp.df_960 <- as(sample_data(DIV_RelA_stats_960), "data.frame") #sample df

#all speices
set.seed(30)

#make bray curtis data matrix
bc.960 <- phyloseq::distance(coralDIV2.prune_stats, method = "bray")
  samp.df_960 <- as(sample_data(coralDIV2.prune_stats), "data.frame") #sample df
#adonis test
adonis(bc.960 ~ SampLoc, data = samp.df_960)
    
# Homogeneity of dispersion test
# betaAll <- betadisper(bc.960, samp.df$Species)
# permutest(betaAll, pairwise = T) 
# (bc.all.HSD <- TukeyHSD(betaAll)) #do you need?
# plot(bc.all.HSD)

#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats.960 <- ordinate(DIV_RelA_stats_960, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats.960)
ord.DIV_RelA_stats.960 <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats.960, display="sites"))) #make df
ord.DIV_RelA_stats.960$SampLoc <- samp.df_960$SampLoc
ord.DIV_RelA_stats.960$sample_name <- samp.df_960$sample_name

ggplot(ord.DIV_RelA_stats.960, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = SampLoc, shape=SampLoc), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  ggtitle("NMDS its2 Bray Curtis 960") +
  theme_classic() 
#ggsave("bc_all.pdf")


#970 ####
DIV_RelA_stats_970<-subset_samples(coralDIV2.prune_stats, TagID=="970")
  DIV_RelA_stats_970 = prune_taxa(taxa_sums(DIV_RelA_stats_970) > 0, DIV_RelA_stats_970) #this removes any OTU with 0s
  samp.df_970 <- as(sample_data(DIV_RelA_stats_970), "data.frame") #sample df

#all speices
set.seed(30)

#make bray curtis data matrix
bc.970 <- phyloseq::distance(coralDIV2.prune_stats, method = "bray")
  samp.df_970 <- as(sample_data(coralDIV2.prune_stats), "data.frame") #sample df
#adonis test
adonis(bc.970 ~ SampLoc, data = samp.df_970)
    
# Homogeneity of dispersion test
# betaAll <- betadisper(bc.all, samp.df$Species)
# permutest(betaAll, pairwise = T) 
# (bc.all.HSD <- TukeyHSD(betaAll)) #do you need?
# plot(bc.all.HSD)

#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats.970 <- ordinate(DIV_RelA_stats_970, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats.970)
ord.DIV_RelA_stats.970 <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats.970, display="sites"))) #make df
ord.DIV_RelA_stats.970$SampLoc <- samp.df_970$SampLoc
ord.DIV_RelA_stats.970$sample_name <- samp.df_970$sample_name
ord.DIV_RelA_stats.970$Sub.loc <- samp.df_970$Sub.loc
ord.DIV_RelA_stats.970$Code<-paste(ord.DIV_RelA_stats.970$SampLoc,ord.DIV_RelA_stats.970$Sub.loc)

ggplot(ord.DIV_RelA_stats.970, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Code, shape=Code), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  ggtitle("NMDS its2 Bray Curtis 970") +
  theme_classic() 
#ggsave("bc_all.pdf")


















#for defense
ggplot(scores.ord.DIV_RelA_statsT1, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Species, shape=Treatment), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(color=Species, fill=4, alpha=0.25)) +
scale_linetype_manual(values=c(1,2,1,2,1,2,1,2))+
  ggtitle("NMDS its2 Bray Curtis") +
  theme_classic()

ggplot(scores.ord.DIV_RelA_statsT1, aes(x = NMDS1, y = NMDS2, color = Species, linetype=Treatment)) +
  geom_point(aes(shape=Treatment), size=4) +
  stat_ellipse(geom = "polygon",
               aes(fill = Code3), 
               alpha = 0.25)+
    theme_classic()

scores.ord.DIV_RelA_statsT1$Code4<-paste(scores.ord.DIV_RelA_statsT1$Species, scores.ord.DIV_RelA_statsT1$Clade, scores.ord.DIV_RelA_statsT1$Treatment)

 p<-ggplot(scores.ord.DIV_RelA_statsT1, aes(x = NMDS1, y = NMDS2, color = Species, linetype=Treatment)) +
  geom_point(aes(shape=Treatment), size=4) +
  stat_ellipse(geom = "polygon",
               aes(fill = Code4), 
               alpha = 0.25)+
    theme_classic()
p+facet_wrap(~Species)

#TF only

DIV_RelA_stats.TF<-subset_samples(DIV_RelA_stats, Time.Point=="TF")
  DIV_RelA_stats.TF = prune_taxa(taxa_sums(DIV_RelA_stats.TF) > 0, DIV_RelA_stats.TF) #this removes any OTU with 0s

#bray curtis presence-absense and abundance

#all speices
set.seed(30)

#make bray curtis data matrix
bc.all <- phyloseq::distance(DIV_RelA_stats.TF, method = "bray")
  samp.df <- as(sample_data(DIV_RelA_stats.TF), "data.frame") #sample df
#adonis test
adonis(bc.all ~ Species*Treatment, data = samp.df)
    

# Homogeneity of dispersion test
betaAll <- betadisper(bc.all, samp.df$Species)
permutest(betaAll, pairwise = T) 
(bc.all.HSD <- TukeyHSD(betaAll)) #do you need?
plot(bc.all.HSD)


#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats.TF <- ordinate(DIV_RelA_stats.TF, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats.TF)
scores.ord.DIV_RelA_stats <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats.TF, display="sites"))) #make df
scores.ord.DIV_RelA_stats$Treatment <- samp.df$Treatment
scores.ord.DIV_RelA_stats$Species <- samp.df$Species
scores.ord.DIV_RelA_stats$Clade <- samp.df$Clade
scores.ord.DIV_RelA_stats$Code3<-paste(scores.ord.DIV_RelA_stats$Species,scores.ord.DIV_RelA_stats$Treatment)

ggplot(scores.ord.DIV_RelA_stats, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Species, shape=Treatment), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, color=Species, group=Code3,lty = Code3)) +
scale_linetype_manual(values=c(1,2,1,2,1,2,1,2))+
  ggtitle("NMDS its2 Bray Curtis TF") +
  theme_classic()
#ggsave("bc_all.pdf")

#for defense

ggplot(scores.ord.DIV_RelA_stats, aes(x = NMDS1, y = NMDS2, color = Species, linetype=Treatment)) +
  geom_point(aes(shape=Treatment), size=4) +
  stat_ellipse(geom = "polygon",
               aes(fill = Code3), 
               alpha = 0.25)+
    theme_classic()

scores.ord.DIV_RelA_stats$Code4<-paste(scores.ord.DIV_RelA_stats$Species, scores.ord.DIV_RelA_stats$Clade, scores.ord.DIV_RelA_stats$Treatment)

 p<-ggplot(scores.ord.DIV_RelA_stats, aes(x = NMDS1, y = NMDS2, color = Species, linetype=Treatment)) +
  geom_point(aes(shape=Treatment), size=4) +
  stat_ellipse(geom = "polygon",
               aes(fill = Code4), 
               alpha = 0.25)+
    theme_classic()
p+facet_wrap(~Species)


#966 ####
DIV_RelA_stats_966<-subset_samples(coralDIV2.prune_stats, TagID=="966")
  DIV_RelA_stats_966 = prune_taxa(taxa_sums(DIV_RelA_stats_966) > 0, DIV_RelA_stats_966) #this removes any OTU with 0s

#all speices
set.seed(30)

#make bray curtis data matrix
bc.966 <- phyloseq::distance(coralDIV2.prune_stats, method = "bray")
  samp.df_966 <- as(sample_data(coralDIV2.prune_stats), "data.frame") #sample df
#adonis test
adonis(bc.966 ~ SampLoc, data = samp.df_966)
    
#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats.966 <- ordinate(DIV_RelA_stats_966, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats.966)
  samp.df_966 <- as(sample_data(DIV_RelA_stats_966), "data.frame") #sample df
ord.DIV_RelA_stats.966 <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats.966, display="sites"))) #make df
ord.DIV_RelA_stats.966$SampLoc <- samp.df_966$SampLoc
ord.DIV_RelA_stats.966$sample_name <- samp.df_966$sample_name

ggplot(ord.DIV_RelA_stats.966, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = SampLoc, shape=SampLoc), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  ggtitle("NMDS its2 Bray Curtis 966") +
  theme_classic() 
#ggsave("bc_all.pdf")

#981 ####
DIV_RelA_stats_981<-subset_samples(coralDIV2.prune_stats, TagID=="981")
  DIV_RelA_stats_981 = prune_taxa(taxa_sums(DIV_RelA_stats_981) > 0, DIV_RelA_stats_981) #this removes any OTU with 0s

#all speices
set.seed(30)

#make bray curtis data matrix
bc.981 <- phyloseq::distance(coralDIV2.prune_stats, method = "bray")
  samp.df_981 <- as(sample_data(coralDIV2.prune_stats), "data.frame") #sample df
#adonis test
adonis(bc.981 ~ SampLoc, data = samp.df_981)


#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats.981 <- ordinate(DIV_RelA_stats_981, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats.981)
  samp.df_981 <- as(sample_data(DIV_RelA_stats_981), "data.frame") #sample df

ord.DIV_RelA_stats.981 <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats.981, display="sites"))) #make df
ord.DIV_RelA_stats.981$SampLoc <- samp.df_981$SampLoc
ord.DIV_RelA_stats.981$sample_name <- samp.df_981$sample_name
ord.DIV_RelA_stats.981$Sub.loc <- samp.df_981$Sub.loc
ord.DIV_RelA_stats.981$Code<-paste(ord.DIV_RelA_stats.981$SampLoc,ord.DIV_RelA_stats.981$Sub.loc)

ggplot(ord.DIV_RelA_stats.981, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Code, shape=Code), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  ggtitle("NMDS its2 Bray Curtis 981") +
  theme_classic() 
#ggsave("bc_all.pdf")


#957 ####
DIV_RelA_stats_957<-subset_samples(coralDIV2.prune_stats, TagID=="957")
  DIV_RelA_stats_957 = prune_taxa(taxa_sums(DIV_RelA_stats_957) > 0, DIV_RelA_stats_957) #this removes any OTU with 0s

#all speices
set.seed(30)

#make bray curtis data matrix
bc.957 <- phyloseq::distance(coralDIV2.prune_stats, method = "bray")
  samp.df_957 <- as(sample_data(coralDIV2.prune_stats), "data.frame") #sample df
#adonis test
adonis(bc.957 ~ SampLoc, data = samp.df_957)


#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats.957 <- ordinate(DIV_RelA_stats_957, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats.957)
  samp.df_957 <- as(sample_data(DIV_RelA_stats_957), "data.frame") #sample df

ord.DIV_RelA_stats.957 <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats.957, display="sites"))) #make df
ord.DIV_RelA_stats.957$SampLoc <- samp.df_957$SampLoc
ord.DIV_RelA_stats.957$sample_name <- samp.df_957$sample_name
ord.DIV_RelA_stats.957$Sub.loc <- samp.df_957$Sub.loc
ord.DIV_RelA_stats.957$Code<-paste(ord.DIV_RelA_stats.957$SampLoc,ord.DIV_RelA_stats.957$Sub.loc)

ggplot(ord.DIV_RelA_stats.957, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Code, shape=Code), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  ggtitle("NMDS its2 Bray Curtis 957") +
  theme_classic() 
#ggsave("bc_all.pdf")





#985 ####
DIV_RelA_stats_985<-subset_samples(coralDIV2.prune_stats, TagID=="985")
  DIV_RelA_stats_985 = prune_taxa(taxa_sums(DIV_RelA_stats_985) > 0, DIV_RelA_stats_985) #this removes any OTU with 0s

#all speices
set.seed(30)

#make bray curtis data matrix
bc.985 <- phyloseq::distance(coralDIV2.prune_stats, method = "bray")
  samp.df_985 <- as(sample_data(coralDIV2.prune_stats), "data.frame") #sample df
#adonis test
adonis(bc.985 ~ SampLoc, data = samp.df_985)


#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats.985 <- ordinate(DIV_RelA_stats_985, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats.985)
  samp.df_985 <- as(sample_data(DIV_RelA_stats_985), "data.frame") #sample df

ord.DIV_RelA_stats.985 <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats.985, display="sites"))) #make df
ord.DIV_RelA_stats.985$SampLoc <- samp.df_985$SampLoc
ord.DIV_RelA_stats.985$sample_name <- samp.df_985$sample_name
ord.DIV_RelA_stats.985$Sub.loc <- samp.df_985$Sub.loc
ord.DIV_RelA_stats.985$Code<-paste(ord.DIV_RelA_stats.985$SampLoc,ord.DIV_RelA_stats.985$Sub.loc)

ggplot(ord.DIV_RelA_stats.985, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Code), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  ggtitle("NMDS its2 Bray Curtis 985") +
  theme_classic() 
#ggsave("bc_all.pdf")


```


